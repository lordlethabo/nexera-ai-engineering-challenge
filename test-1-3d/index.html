<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>NexEra AI – 3D Viewer</title>

    <!-- Three.js CDN -->
    <script src="https://unpkg.com/three@0.158.0/build/three.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="style.css" />
</head>

<body>
    <div id="scene-container"></div>

    <script>
        // =====================================================
        // 1. BASIC THREE.JS SETUP
        // =====================================================

        const container = document.getElementById("scene-container");

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf5f5f5);

        const camera = new THREE.PerspectiveCamera(
            60,
            container.clientWidth / container.clientHeight,
            0.1,
            1000
        );
        camera.position.set(0, 1.5, 4);

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);

        // =====================================================
        // 2. LIGHTING
        // =====================================================

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(3, 5, 2);
        scene.add(directionalLight);

        // =====================================================
        // 3. GLOBAL OBJECT HOLDER
        // =====================================================

        let currentMesh = null;

        function clearScene() {
            if (currentMesh) {
                scene.remove(currentMesh);
                currentMesh.geometry.dispose();
                currentMesh.material.dispose();
                currentMesh = null;
            }
        }

        // =====================================================
        // 4. SHAPE FACTORY
        // =====================================================

        function createShape(shape, color) {
            let geometry;

            switch (shape) {
                case "sphere":
                    geometry = new THREE.SphereGeometry(1, 32, 32);
                    break;

                case "cone":
                    geometry = new THREE.ConeGeometry(1, 2, 32);
                    break;

                default:
                    geometry = new THREE.BoxGeometry(1.5, 1.5, 1.5);
            }

            const material = new THREE.MeshStandardMaterial({
                color: color,
                roughness: 0.4,
                metalness: 0.1
            });

            const mesh = new THREE.Mesh(geometry, material);
            mesh.position.y = 1;

            return mesh;
        }

        // =====================================================
        // 5. BRIDGE FUNCTION (CALLED FROM PYTHON)
        // =====================================================

        function renderFromAI(shape, color) {
            clearScene();
            currentMesh = createShape(shape, color);
            scene.add(currentMesh);
        }

        // Expose function globally
        window.renderFromAI = renderFromAI;

        // =====================================================
        // 6. POSTMESSAGE LISTENER (Gradio → iframe)
        // =====================================================

        window.addEventListener("message", (event) => {
            if (!event.data) return;

            if (event.data.type === "RENDER") {
                renderFromAI(event.data.shape, event.data.color);
            }
        });

        // =====================================================
        // 7. RENDER LOOP
        // =====================================================

        function animate() {
            requestAnimationFrame(animate);

            if (currentMesh) {
                currentMesh.rotation.y += 0.01;
            }

            renderer.render(scene, camera);
        }

        animate();

        // =====================================================
        // 8. RESPONSIVE RESIZE
        // =====================================================

        window.addEventListener("resize", () => {
            const width = container.clientWidth;
            const height = container.clientHeight;

            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
        });
    </script>
</body>
</html>
